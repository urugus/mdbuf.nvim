name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  LANG: C.UTF-8
  LC_ALL: C.UTF-8

jobs:
  lint-typescript:
    name: Lint TypeScript
    runs-on: ubuntu-slim
    defaults:
      run:
        working-directory: server
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Biome lint
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

  test-unit:
    name: Unit Tests (Vitest)
    runs-on: ubuntu-slim
    defaults:
      run:
        working-directory: server
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test

  build-server:
    name: Build Server
    runs-on: ubuntu-slim
    defaults:
      run:
        working-directory: server
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

  lint-lua:
    name: Lint Lua
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v4

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: '5.1'

      - name: Setup LuaRocks
        uses: leafo/gh-actions-luarocks@v4

      - name: Install luacheck
        run: luarocks install luacheck

      - name: Run luacheck
        run: luacheck lua/ --globals vim

  test-render:
    name: Test Render
    runs-on: ubuntu-slim
    defaults:
      run:
        working-directory: server
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Test render CLI
        run: |
          echo "# Test Document" > test.md
          echo "" >> test.md
          echo "Hello, World!" >> test.md
          npm run render -- test.md test-output.png
          test -f test-output.png && echo "Render successful"
